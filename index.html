<!DOCTYPE html>
<html>
<head>
    <title>Battle Bike</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <link href="assets/demoStyles.css" rel="stylesheet" type="text/css" />

    <script src="cordova.js"></script>

    <script type="text/javascript" src="src/easeljs/utils/UID.js"></script>
    <script type="text/javascript" src="src/easeljs/geom/Matrix2D.js"></script>
    <script type="text/javascript" src="src/easeljs/events/EventDispatcher.js"></script>
    <script type="text/javascript" src="src/easeljs/display/DisplayObject.js"></script>
    <script type="text/javascript" src="src/easeljs/display/Container.js"></script>
    <script type="text/javascript" src="src/easeljs/display/Stage.js"></script>
    <script type="text/javascript" src="src/easeljs/events/MouseEvent.js"></script>
    <script type="text/javascript" src="src/easeljs/display/Shape.js"></script>
    <script type="text/javascript" src="src/easeljs/display/Graphics.js"></script>
    <script type="text/javascript" src="src/easeljs/utils/Ticker.js"></script>
    <script type="text/javascript" src="src/easeljs/display/Text.js"></script>
    <script type="text/javascript" src="src/easeljs/ui/Touch.js"></script>
    <script type="text/javascript" src="src/easeljs/geom/Point.js"></script>

    <!-- We also provide hosted minified versions of all CreateJS libraries.
       http://code.createjs.com -->

    <script>

        var canvas, stage;
        var drawingCanvas;
        var oldPt;
        var oldMidPt;
        var title;
        var color;
        var stroke;
        var colors;
        var index;
 
 var BB={};



 BB.oldPt=new Array();
 BB.oldMidPt=new Array();
 BB.color=new Array();
 BB.stroke=new Array();

BB.init2button=function(x, y) {
    //Create a Shape DisplayObject.
    var circle = new createjs.Shape();
    circle.graphics.beginStroke("#eeeeee").beginFill("#aaaaaa").drawCircle(0, 0, 40).drawRoundRect(0, 0, 5, 40, 2);
    //Set position of Shape instance.
    circle.x = x;
    circle.y = y;

    //Add Shape instance to stage display list.
    stage.addChild(circle);

    return circle;
}

BB.init2player=function(x, y) {
    //Create a Shape DisplayObject.
    var s = new createjs.Shape();
    s.graphics.beginStroke("#eeeeee").beginFill("#aaffaa").drawCircle(0, 0, 10).drawRoundRect(0, -1, 5, 3, 2);
    //Set position of Shape instance.
    s.x = x;
    s.y = y;

    //Add Shape instance to stage display list.
    stage.addChild(s);

    return s;
}

BB.init2npc=function(x, y, cf) {
   //Create a Shape DisplayObject.
   var s = new createjs.Shape();
   s.graphics.beginStroke("#eeeeee").beginFill(cf).drawCircle(0, 0, 10);
   //Set position of Shape instance.
   s.x = x;
   s.y = y;

    //Add Shape instance to stage display list.
   stage.addChild(s);

   var next=BB.npc.length;
   BB.npc[next]=s;
   BB.npa[next]=Math.round(360*Math.random());
   BB.npr[next]=Math.round(20*Math.random());
   BB.npdx[next]=0;
   BB.npdy[next]=0;

   return s;
}


BB.init2hud=function() {
    BB.init2button(BB.w3, 50);
    BB.init2button(2*BB.w3, 50);

    BB.init2button(50, BB.h3);
    BB.init2button(50, 2*BB.h3);

    BB.init2button(BB.w3, BB.height-50);
    BB.init2button(2*BB.w3, BB.height-50);

    BB.init2button(BB.width-50, BB.h3);
    BB.init2button(BB.width-50, 2*BB.h3);
}

BB.npc=new Array();
BB.npa=new Array();
BB.npr=new Array();
BB.npdx=new Array();
BB.npdy=new Array();

BB.init2npcs=function() {
    BB.init2npc(BB.w3, BB.h3, "#ff0000");
    BB.init2npc(2*BB.w3, BB.h3, "#ff0000");
    BB.init2npc(BB.w3, 2*BB.h3, "#ff0000");
    BB.init2npc(2*BB.w3, 2*BB.h3, "#ff0000");
    BB.init2npc(BB.w2, BB.h2, "#ff0000");
}

BB.npc2update=function(pid) {

   var npc=BB.npc[pid];

   npc.x += BB.npdx[pid];
   npc.y += BB.npdy[pid];

   if (npc.x <0) npc.x=BB.width;
   else if (npc.x >BB.width) npc.x=0;

   if (npc.y <0) npc.y=BB.height;
   else if (npc.y >BB.height) npc.y=0;
};


BB.player1=null;
BB.player2=null;
BB.player3=null;
BB.player4=null;

BB.init2players=function() {
    BB.player1=BB.init2player(BB.w4, BB.h2);
    BB.player2=BB.init2player(3*BB.w4, BB.h2);
    BB.player3=BB.init2player(BB.w2, BB.h4);
    BB.player4=BB.init2player(BB.w2, 3*BB.h4);
}

BB.dx1=1;
BB.dy1=0;
BB.dx2=-1;
BB.dy2=0;
BB.dx3=0;
BB.dy3=1;
BB.dx4=0;
BB.dy4=-1;

BB.mx=new Array(1,-1,0,0);
BB.my=new Array(0,0,1,-1);
BB.mr=new Array(16,16,16,16); // radius
BB.ma=new Array(0,180,270,90); // angle
BB.power=new Array(10,10,10,10); // angle

BB.player2update=function(player, pid) {

   player.x += BB.mx[pid];
   player.y += BB.my[pid];

   if (player.x <0) player.x=BB.width;
   if (player.y <0) player.y=BB.height;
   if (player.x >BB.width) player.x=0;
   if (player.y >BB.height) player.y=0;

   var power=BB.power[pid];
   //player.graphics.drawCircle(0, 0, power);
   player.scaleX = player.scaleY = power/10;
   player.rotation = BB.ma[pid];

   if (power < 100) BB.power[pid]=power+1;
};

BB.frame2update=function (event) {
   stage.clear();

   BB.frame2players();
   BB.frame2npcs();

   stage.update();
};

BB.frame2players=function (event) {

   for (var p=0; p<BB.mx.length; p++) {
      var dr=4*Math.random()-2;
      BB.mr[p]+=Math.round(dr);

      if (BB.mr[p] <0) BB.mr[p]=0;
      if (BB.mr[p] >20) BB.mr[p]=20;

      var da=16*Math.random()-8;
      BB.ma[p]= (BB.ma[p]+Math.round(da)) % 360;
      
      var dx=BB.mr[p] * Math.cos(BB.ma[p]*Math.PI/180);
      var dy=BB.mr[p] * Math.sin(BB.ma[p]*Math.PI/180);

      BB.mx[p]=Math.round(dx);
      BB.my[p]=Math.round(dy);
   }
   // Actions carried out each frame
   BB.player2update(BB.player1, 0);
   BB.player2update(BB.player2, 1);
   BB.player2update(BB.player3, 2);
   BB.player2update(BB.player4, 3);

};

BB.frame2npcs=function (event) {

   for (var p=0; p<BB.npc.length; p++) {
      var dr=4*Math.random()-2;
      BB.npr[p]+=Math.round(dr);

      if (BB.npr[p] <0) BB.npr[p]=0;
      if (BB.npr[p] >20) BB.npr[p]=20;

      var da=16*Math.random()-8;
      BB.npa[p]= (BB.npa[p]+Math.round(da)) % 360;
      
      var dx=BB.npr[p] * Math.cos(BB.npa[p]*Math.PI/180);
      var dy=BB.npr[p] * Math.sin(BB.npa[p]*Math.PI/180);

      BB.npdx[p]=Math.round(dx);
      BB.npdy[p]=Math.round(dy);

      BB.npc2update(p);
   }

};



function init() {
            if (window.top != window) {
                document.getElementById("header").style.display = "none";
            }
            canvas = document.getElementById("myCanvas");

            canvas.addEventListener("touchstart", function(e) { e.preventDefault(); }, false);
            canvas.addEventListener("touchend", function(e) { e.preventDefault(); }, false);

            index = 0;
            colors = ["#828b20", "#b0ac31", "#cbc53d", "#fad779", "#f9e4ad", "#faf2db", "#563512", "#9b4a0b", "#d36600", "#fe8a00", "#f9a71f"];

            //check to see if we are running in a browser with touch support
            stage = new createjs.Stage(canvas);
            stage.autoClear = false;
            //stage.autoClear = true;
            stage.enableDOMEvents(true);

            createjs.Touch.enable(stage);
            createjs.Ticker.setFPS(24);

            BB.width=stage.canvas.width; // canvas size
            BB.height=stage.canvas.height;

            BB.w2=Math.round(BB.width/2);
            BB.h2=Math.round(BB.height/2);
            BB.w3=Math.round(BB.width/3);
            BB.h3=Math.round(BB.height/3);
            BB.w4=Math.round(BB.width/4);
            BB.h4=Math.round(BB.height/4);

            drawingCanvas = new createjs.Shape();

            stage.addEventListener("stagemousedown", handleMouseDown);
            stage.addEventListener("stagemouseup", handleMouseUp);
            stage.addEventListener("stagemousemove" , handleMouseMove);

            title = new createjs.Text("BATTLE BIKE by Applh.com", "36px Arial", "#777777");
            title.x = BB.w3;
            title.y = BB.h3;
            stage.addChild(title);

            stage.addChild(drawingCanvas);
            //Update stage will render next frame
            stage.update();

            BB.init2hud();
            BB.init2npcs();
            BB.init2players();

            createjs.Ticker.addEventListener("tick", BB.frame2update);
            //createjs.Ticker.addEventListener("tick", stage);
        }

  
        function stop() {
            //createjs.Ticker.removeEventListener("tick", tick);
        }

        function handleMouseDown(event) {

            if (stage.contains(title)) { stage.clear(); stage.removeChild(title); }

            color = colors[(index++)%colors.length];
            stroke = Math.random()*30 + 10 | 0;
            var smx=event.stageX;
            var smy=event.stageY;
            //oldPt = new createjs.Point(stage.mouseX, stage.mouseY);
            oldPt = new createjs.Point(smx, smy);
            oldMidPt = oldPt;

            var pid=event.pointerID;
            BB.oldPt[pid]=oldPt;
            BB.oldMidPt[pid]=oldMidPt;
            BB.color[pid]=color;
            BB.stroke[pid]=stroke;

            //stage.addEventListener("stagemousemove" , handleMouseMove);
        }

        function handleMouseMove(event) {

            var pid=event.pointerID;
            var smx=event.stageX;
            var smy=event.stageY;
            oldPt=BB.oldPt[pid];
            oldMidPt=BB.oldMidPt[pid];
            color=BB.color[pid];
            stroke=BB.stroke[pid];

            //var midPt = new createjs.Point(oldPt.x + stage.mouseX>>1, oldPt.y+stage.mouseY>>1);
            var midPt = new createjs.Point(oldPt.x + smx>>1, oldPt.y+smy>>1);

            drawingCanvas.graphics.clear().setStrokeStyle(stroke, 'round', 'round').beginStroke(color).moveTo(midPt.x, midPt.y).curveTo(oldPt.x, oldPt.y, oldMidPt.x, oldMidPt.y);

            oldPt.x = stage.mouseX;
            oldPt.y = stage.mouseY;

            oldMidPt.x = midPt.x;
            oldMidPt.y = midPt.y;

            //stage.update();
        }

        function handleMouseUp(event) {
            //stage.removeEventListener("stagemousemove" , handleMouseMove);
        }

    </script>
</head>
<body onload="init();">
<canvas id="myCanvas" width="2048" height="1536" style="width:100%;height:100%;"></canvas>
</body>
</html>
